// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id              Int        @id @default(autoincrement())
  email           String     @unique
  name            String?
  firstName       String?    @map("first_name")
  lastName        String?    @map("last_name")
  photoUrl        String?    @map("photo_url")
  timezone        String     @default("UTC")
  language        String     @default("en")
  status          UserStatus @default(INACTIVE)
  type            UserType   @default(CUSTOMER)
  emailVerifiedAt DateTime?  @map("email_verified_at")
  totpEnabled     Boolean    @default(false) @map("totp_enabled")
  totpSecret      String?    @map("totp_secret")
  
  // Shadow User Fields
  dateInvited     DateTime?  @map("date_invited")
  dateJoined      DateTime?  @map("date_joined")

  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // Relations
  localAuthAccount         LocalAuthAccount?
  oauthAccounts            OAuthAccount[]
  sessions                 Session[]
  verificationRequests     VerificationRequest[]
  backupCodes              MfaBackupCode[]
  mfaChallengeSessions     MfaChallengeSession[]
  subscriptions            Subscription[]
  ownedWorkspaces          Workspace[]                @relation("OwnedWorkspaces")
  workspaceMembers         WorkspaceMember[]
  sentWorkspaceInvitations WorkspaceInvitation[]      @relation("SentInvitations")
  receivedWorkspaceInvitations WorkspaceInvitation[]  @relation("ReceivedInvitations")
  devices                  Device[]
  notifications            Notification[]
  stripeCheckoutSessions   StripeCheckoutSession[]

  @@map("users")
}

model LocalAuthAccount {
  id           Int      @id @default(autoincrement())
  userId       Int      @unique @map("user_id")
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  User User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("local_auth_accounts")
}

model OAuthAccount {
  id             Int           @id @default(autoincrement())
  userId         Int           @map("user_id")
  provider       OAuthProvider
  providerUserId String        @map("provider_user_id")
  accessToken    String?       @map("access_token") @db.Text
  refreshToken   String?       @map("refresh_token") @db.Text
  expiresAt      Int?          @map("expires_at")
  tokenType      String?       @map("token_type")
  scope          String?
  metadata       Json?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  User User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@map("oauth_accounts")
}

model Session {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  refreshToken String   @map("refresh_token")
  userAgent    String?  @map("user_agent")
  ipAddress    String?  @map("ip_address")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  User User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationRequest {
  id        Int                     @id @default(autoincrement())
  userId    Int                     @map("user_id")
  email     String
  token     String                  @unique
  type      VerificationRequestType
  expiresAt DateTime                @map("expires_at")
  createdAt DateTime                @default(now()) @map("created_at")

  User User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([email, token])
  @@map("verification_requests")
}

model MfaBackupCode {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  code      String // Hashed backup code
  used      Boolean   @default(false)
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  User User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mfa_backup_codes")
}

model MfaChallengeSession {
  id           Int                       @id @default(autoincrement())
  sessionToken String                    @unique @map("session_token")
  userId       Int                       @map("user_id")
  email        String
  mfaMethod    MfaMethod                 @map("mfa_method")
  status       MfaChallengeSessionStatus @default(pending)
  expiresAt    DateTime                  @map("expires_at")
  createdAt    DateTime                  @default(now()) @map("created_at")

  User User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mfa_challenge_sessions")
}

// ============================================
// PLANS & SUBSCRIPTIONS
// ============================================

model Plan {
  id          Int      @id @default(autoincrement())
  name        String   // "free", "pro", "enterprise"
  slug        String   @unique // URL-friendly identifier
  displayName String   @map("display_name") // "Free", "Pro", "Enterprise"
  description String?
  planType    PlanType @map("plan_type")

  // Feature flags
  apiAccess         Boolean @default(false) @map("api_access")
  prioritySupport   Boolean @default(false) @map("priority_support")
  customDomain      Boolean @default(false) @map("custom_domain")
  advancedAnalytics Boolean @default(false) @map("advanced_analytics")
  webhookSupport    Boolean @default(false) @map("webhook_support")
  teamCollaboration Boolean @default(false) @map("team_collaboration")

  // Limits
  maxSeats        Int @map("max_seats") // Maximum team members (owner + members)
  maxTeamMembers  Int @map("max_team_members") // Maximum additional team members (excluding owner)
  maxWorkspaces   Int @map("max_workspaces") // Maximum teams/workspaces user can create

  // Pricing (in cents)
  monthlyPrice Decimal? @map("monthly_price") @db.Decimal(10, 2)
  yearlyPrice  Decimal? @map("yearly_price") @db.Decimal(10, 2)

  // Stripe integration
  stripeMonthlyPriceId String? @map("stripe_monthly_price_id")
  stripeYearlyPriceId  String? @map("stripe_yearly_price_id")

  // Plan metadata
  isActive     Boolean  @default(true) @map("is_active")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  subscriptions          Subscription[]
  subscriptionHistory    SubscriptionHistory[]
  stripeCheckoutSessions StripeCheckoutSession[]

  @@map("plans")
}

model Subscription {
  id     Int                @id @default(autoincrement())
  userId Int                @map("user_id") // Owner of the subscription
  planId Int                @map("plan_id")
  status SubscriptionStatus @default(ACTIVE)

  // Stripe details
  stripeCustomerId      String? @map("stripe_customer_id")
  stripeSubscriptionId String? @unique @map("stripe_subscription_id")
  stripePaymentMethodId String? @map("stripe_payment_method_id")

  // Billing
  billingInterval BillingInterval @default(MONTHLY) @map("billing_interval")

  // Subscription period
  currentPeriodStart DateTime  @map("current_period_start")
  currentPeriodEnd   DateTime? @map("current_period_end") // null for free plans (never expires)
  cancelAtPeriodEnd  Boolean   @default(false) @map("cancel_at_period_end")
  canceledAt         DateTime? @map("canceled_at")

  // Trial information
  trialStart DateTime? @map("trial_start")
  trialEnd   DateTime? @map("trial_end")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  User                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  Plan                Plan                 @relation(fields: [planId], references: [id])
  subscriptionHistory SubscriptionHistory[]

  @@map("subscriptions")
}

model SubscriptionHistory {
  id            Int                @id @default(autoincrement())
  subscriptionId Int                @map("subscription_id")
  planId        Int                @map("plan_id")
  status        SubscriptionStatus
  billingInterval BillingInterval  @map("billing_interval")

  // Snapshot of period
  currentPeriodStart DateTime @map("current_period_start")
  currentPeriodEnd   DateTime @map("current_period_end")

  createdAt DateTime @default(now()) @map("created_at")

  Subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  Plan         Plan         @relation(fields: [planId], references: [id])

  @@index([subscriptionId])
  @@map("subscription_history")
}

model StripeCheckoutSession {
  id                   Int                   @id @default(autoincrement())
  stripeSessionId      String                @unique @map("stripe_session_id")
  userId               Int                   @map("user_id")
  planId               Int                   @map("plan_id")
  billingInterval      BillingInterval       @map("billing_interval")
  status               CheckoutSessionStatus @default(PENDING)
  stripeCustomerId     String?               @map("stripe_customer_id")
  stripeSubscriptionId String?               @map("stripe_subscription_id")
  errorMessage         String?               @map("error_message")
  processedAt          DateTime?             @map("processed_at")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")

  User User @relation(fields: [userId], references: [id], onDelete: Cascade)
  Plan Plan @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([status, createdAt])
  @@map("stripe_checkout_sessions")
}

// ============================================
// WORKSPACES
// ============================================

model Workspace {
  id        Int      @id @default(autoincrement())
  name      String
  slug      String
  image     String? // Workspace logo/avatar URL
  ownerId   Int      @map("owner_id") // User who owns the workspace
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  Owner  User             @relation("OwnedWorkspaces", fields: [ownerId], references: [id], onDelete: Cascade)
  members WorkspaceMember[]
  invitations WorkspaceInvitation[]

  @@unique([ownerId, slug]) // Slug unique per owner
  @@index([ownerId]) // Index for owner lookups
  @@map("workspaces")
}

model WorkspaceMember {
  id          Int                  @id @default(autoincrement())
  workspaceId Int                  @map("workspace_id")
  userId      Int                  @map("user_id")
  role        WorkspaceMemberRole  @default(MEMBER)
  createdAt   DateTime             @default(now()) @map("created_at")
  updatedAt   DateTime             @updatedAt @map("updated_at")

  Workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId]) // Index for workspace member queries
  @@index([userId]) // Index for user's workspace memberships
  @@map("workspace_members")
}

model WorkspaceInvitation {
  id          Int                  @id @default(autoincrement())
  workspaceId Int                  @map("workspace_id")
  email       String
  token       String               @unique
  role        WorkspaceMemberRole  @default(MEMBER)

  inviterId   Int                  @map("inviter_id")
  inviteeId   Int?                 @map("invitee_id") // Link to Shadow User

  inviteCode  Int?                 @map("invite_code")
  status      InvitationStatus     @default(PENDING)

  acceptedAt  DateTime?            @map("accepted_at")
  rejectedAt  DateTime?            @map("rejected_at")
  expiresAt   DateTime             @map("expires_at")
  createdAt   DateTime             @default(now()) @map("created_at")
  updatedAt   DateTime             @updatedAt @map("updated_at")

  Workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  Inviter   User      @relation("SentInvitations", fields: [inviterId], references: [id], onDelete: Cascade)
  Invitee   User?     @relation("ReceivedInvitations", fields: [inviteeId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, email])
  @@index([token])
  @@index([email])
  @@index([workspaceId])
  @@map("workspace_invitations")
}

// ============================================
// PUSH NOTIFICATIONS
// ============================================

model Device {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  fcmToken   String    @unique @db.VarChar(255) @map("fcm_token")
  platform   String    @db.VarChar(50) // "web" | "android" | "ios"
  enabled    Boolean   @default(true)

  // FCM delivery tracking
  lastDeliveryStatus     String?   @map("last_delivery_status") // "success" | "failed"
  lastDeliveryError      String?   @map("last_delivery_error")
  lastDeliveryAttemptAt  DateTime? @map("last_delivery_attempt_at")
  isInvalidToken         Boolean   @default(false) @map("is_invalid_token")
  invalidTokenReportedAt DateTime? @map("invalid_token_reported_at")

  lastSeenAt DateTime  @updatedAt @map("last_seen_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isInvalidToken])
  @@map("devices")
}

model Notification {
  id        Int                  @id @default(autoincrement())
  userId    Int                  @map("user_id")
  category  NotificationCategory @default(USER)
  title     String               @db.VarChar(255)
  body      String               @db.Text
  type      String               @db.VarChar(100)
  payload   Json?     
  readAt    DateTime?            @map("read_at")
  createdAt DateTime             @default(now()) @map("created_at")
  updatedAt DateTime             @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, category])
  @@index([userId, readAt])
  @@map("notifications")
}

model WebhookEventLog {
  id              Int      @id @default(autoincrement())
  source          String   @db.VarChar(50) // "brevo", "stripe", etc.
  event           String   @db.VarChar(100)
  externalEventId String?  @map("external_event_id") // Brevo's "id", Stripe's event id
  referenceId     String?  @map("reference_id") @db.VarChar(255) // message-id, payment_intent, etc.
  payload         Json
  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([source, referenceId, event])
  @@index([source])
  @@index([event])
  @@index([externalEventId])
  @@index([referenceId])
  @@index([createdAt])
  @@map("webhook_event_logs")
}

// ============================================
// ENUMS
// ============================================

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
  INVITED
}

enum NotificationCategory {
  USER
  SYSTEM
}

enum UserType {
  CUSTOMER
  ADMIN
}

enum OAuthProvider {
  GOOGLE
  GITHUB
}

enum VerificationRequestType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum MfaMethod {
  TOTP
  BACKUP_CODE
}

enum MfaChallengeSessionStatus {
  pending
  verified
  expired
  failed
}

enum PlanType {
  FREE
  PAID
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  UNPAID
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

enum CheckoutSessionStatus {
  PENDING
  COMPLETED
  EXPIRED
  FAILED
}

enum WorkspaceMemberRole {
  OWNER
  MANAGER
  MEMBER
  READ_ONLY
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}